from django.db import models
from django.contrib.auth.models import User

class Payment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(max_length=3, default='INR')
    order_id = models.CharField(max_length=255)
    razorpay_payment_id = models.CharField(max_length=255)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"{self.user.username} - {self.amount} {self.currency}"

from django.shortcuts import render
from django.conf import settings
from .models import Payment
import razorpay

def initiate_payment(request):
    if request.method == "POST":
        amount = int(request.POST.get('amount')) * 100  # convert to paisa
        client = razorpay.Client(auth=(settings.RAZORPAY_API_KEY, settings.RAZORPAY_API_SECRET))
        payment = client.order.create({'amount': amount, 'currency': 'INR', 'payment_capture': '1'})
        # Save payment details to the database
        payment_obj = Payment.objects.create(
            user=request.user,  # Assuming you have authenticated users
            amount=amount / 100,  # Convert back to rupees
            currency='INR',
            order_id=payment['id'],
            razorpay_payment_id='',
        )
        return render(request, 'payment.html', {'payment': payment})
    return render(request, 'index.html')
# const { QueryTypes } = require("sequelize");
# const sequelize = require("../database");
# const user = require('../modules/user')
# const  bcrypt = require('bcrypt')
# const profilepictureauthenticate = require('../middlewares/profilepictureauthenticate')

# const insertdata = async(req,res)=>{
    
#     const {
#         id,
#         firstname,
#         lastname,
#         email,
#         password,
#         gender,
#         hobbies,
#         departmentid,
#         profile_picture
#       } = req.body;
    
#       const securPass = await bcrypt.hash(password,10)

#     try{
#         await profilepictureauthenticate(req, res, async function (err) {
#             if (err) {
#                 return res.status(400).json({ error: err });
#             }

#             if (!req.file) {
#                 return res.status(400).json({ error: "Error: No File Selected!" });
#             }

#         await sequelize.query(`Insert INTO Users (id,firstname,lastname,email,password,gender,hobbies,departmentid,profile_picture)
#         VALUES (${id},'${firstname}','${lastname}','${email}','${securPass}','${gender}','${hobbies}',${departmentid},'${profile_picture}')`,
#         {
#             type:QueryTypes.INSERT,
#         });
#         res.status(200).json({ message: "User added successfully" });
#     });
#     }
#     catch(error){
#         console.error("Error adding user:", error);
#         res.status(500).json({ error: "Internal Server Error" });
#     }
# };

# module.exports = insertdata;
